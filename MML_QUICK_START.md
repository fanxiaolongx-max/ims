# MML 管理界面 - 快速开始

IMS SIP Server 的全新 MML 管理界面快速使用指南。

---

## 🎯 什么是 MML？

MML（Man-Machine Language）是电信运营商级设备的标准管理方式，类似华为、爱立信等厂商的网管界面。

**优势：**
- ✅ 命令结构化，易于脚本化
- ✅ 批量操作，效率高
- ✅ 专业运维友好
- ✅ 符合运营商习惯

---

## 🚀 5 分钟快速上手

### Step 1: 安装依赖

```bash
cd /Volumes/512G/06-工具开发/ims

# 安装 MML 界面所需依赖
pip install websockets psutil
```

### Step 2: 启动服务器

```bash
python run.py
```

输出：
```
[MML] MML 管理界面已启动: http://0.0.0.0:8888
[MML] WebSocket 日志推送服务已启动: ws://0.0.0.0:8889
[INFO] UDP server listening on 0.0.0.0:5060
```

### Step 3: 访问界面

打开浏览器，访问：
```
http://localhost:8888
```

**界面预览：**
```
┌─────────────────────────────────────────────────────────────┐
│ 🖥️ IMS MML 管理终端              ● 服务运行中  12:00:00      │
├──────────┬────────────────────────────────┬─────────────────┤
│          │                                │                 │
│ 📚 命令树 │  欢迎使用 IMS MML 管理终端      │  📋 实时日志     │
│ ┌──────┐ │                                │                 │
│ │系统管理│ │  快速开始:                     │  12:00:01 INFO  │
│ │用户管理│ │    DSP SYSINFO - 系统信息      │  日志系统启动    │
│ │注册管理│ │    DSP REG ALL - 注册列表      │                 │
│ │呼叫管理│ │    HELP ALL - 命令帮助         │  12:00:02 INFO  │
│ │CDR管理 │ │                                │  服务检查...    │
│ └──────┘ │                                │                 │
├──────────┴────────────────────────────────┴─────────────────┤
│ MML> _                                            [执行]    │
└─────────────────────────────────────────────────────────────┘
```

---

## 📝 第一条命令

### 查看系统信息

在命令输入框输入：
```
DSP SYSINFO
```

按回车或点击"执行"按钮。

**输出示例：**
```
============================================================
系统信息
============================================================
服务器名称    : IMS SIP Server
版本          : 2.0.0
操作系统      : Darwin 25.0.0
Python 版本   : 3.11.0
服务器 IP     : 0.0.0.0
服务器端口    : 5060
系统运行时间  : 0小时5分钟
CPU 核心数    : 8
总内存        : 16.00 GB
============================================================
```

---

## 🎓 常用命令示例

### 1. 查看注册列表

```bash
DSP REG ALL
```

**输出：**
```
================================================================================
注册列表
================================================================================
AOR                                      Contact                        Expires
--------------------------------------------------------------------------------
sip:1001@192.168.1.1                     sip:1001@192.168.1.100:5060   3600
sip:1002@192.168.1.1                     sip:1002@192.168.1.101:5060   3600
--------------------------------------------------------------------------------
总计: 2 条注册记录
================================================================================
```

### 2. 查看活跃呼叫

```bash
DSP CALL ACTIVE
```

### 3. 查看今日 CDR

```bash
DSP CDR DATE=TODAY TYPE=CALL
```

### 4. 修改日志级别

```bash
SET LOG LEVEL=DEBUG
```

**输出：**
```
日志级别已更新: DEBUG
```

### 5. 查看服务状态

```bash
DSP SRVSTAT
```

**输出：**
```
============================================================
服务状态
============================================================
进程 ID        : 12345
CPU 使用率     : 5.2%
内存使用       : 128.50 MB
线程数         : 8
活跃注册数     : 2
活跃呼叫数     : 0
待处理请求     : 0
============================================================
```

### 6. 查看配置

```bash
DSP CFG ALL
```

### 7. 保存配置

```bash
SAVE CFG
```

### 8. 获取帮助

```bash
HELP ALL
```

---

## 💡 界面使用技巧

### 1️⃣ 使用左侧命令树

**操作：**
1. 点击左侧分类（如"系统管理"）展开
2. 点击具体命令（如"查询系统状态"）
3. 命令自动填充到输入框
4. 修改参数后执行

**示例：**
```
点击: "CDR管理" → "查询今日CDR"
自动填充: DSP CDR DATE=TODAY TYPE={type}
修改为: DSP CDR DATE=TODAY TYPE=CALL
执行
```

### 2️⃣ 命令历史

- 按 `↑` 键：上一条命令
- 按 `↓` 键：下一条命令
- 自动保存所有执行过的命令

### 3️⃣ 搜索命令

在左侧顶部搜索框输入关键词：
```
搜索: "注册"
结果: 显示所有包含"注册"的命令
```

### 4️⃣ 实时日志

**右侧日志面板功能：**
- **自动滚动**：最新日志自动显示
- **暂停/继续**：点击"暂停"按钮停止滚动
- **清空**：点击"清空"按钮清除日志
- **颜色标识**：
  - 🔵 DEBUG - 灰色
  - 🟢 INFO - 青色
  - 🟡 WARNING - 黄色
  - 🔴 ERROR - 红色

---

## 📚 命令速查表

### 系统管理

| 命令 | 说明 |
|-----|------|
| `DSP SYSINFO` | 系统信息 |
| `DSP SYSCFG` | 系统配置 |
| `DSP SRVSTAT` | 服务状态 |
| `SET LOGLEVEL LEVEL=DEBUG` | 设置日志级别 |

### 注册管理

| 命令 | 说明 |
|-----|------|
| `DSP REG ALL` | 所有注册 |
| `DSP REG STAT` | 注册统计 |
| `RMV REG URI=xxx CONFIRM=YES` | 强制注销 |

### 呼叫管理

| 命令 | 说明 |
|-----|------|
| `DSP CALL ACTIVE` | 活跃呼叫 |
| `DSP CALL STAT` | 呼叫统计 |
| `RMV CALL CALLID=xxx CONFIRM=YES` | 强制挂断 |

### CDR 管理

| 命令 | 说明 |
|-----|------|
| `DSP CDR DATE=TODAY TYPE=CALL` | 今日呼叫 CDR |
| `DSP CDR DATE=2025-10-27 TYPE=MESSAGE` | 指定日期短信 CDR |
| `DSP CDR STAT DATE=TODAY` | CDR 统计 |

### 配置管理

| 命令 | 说明 |
|-----|------|
| `DSP CFG ALL` | 所有配置 |
| `SET CFG KEY=xxx VALUE=yyy` | 修改配置 |
| `SAVE CFG` | 保存配置 |

---

## ⚙️ 进阶使用

### 批量操作（计划中）

未来支持脚本化批量操作：

```bash
# 批量查询脚本 (batch.mml)
DSP SYSINFO
DSP REG ALL
DSP CALL ACTIVE
DSP CDR DATE=TODAY TYPE=CALL
```

执行：
```bash
mml-cli execute batch.mml
```

### 定时任务（计划中）

```bash
# 每小时导出 CDR
SCHEDULE EVERY=1H CMD="EXP CDR DATE=TODAY TYPE=CALL"
```

---

## 🐛 常见问题

### Q1: WebSocket 连接失败？

**症状**：右侧日志显示 "WebSocket 连接错误"

**解决**：
```bash
pip install websockets
```

重启服务器。

### Q2: 命令无响应？

**检查：**
1. 查看服务器日志
2. 确认命令格式正确
3. 输入 `HELP ALL` 查看支持的命令

### Q3: 如何查看命令帮助？

```bash
HELP CMD=DSP
```

### Q4: 参数如何填写？

**格式：** `KEY=VALUE`

**示例：**
```bash
# 正确
DSP CDR DATE=2025-10-27 TYPE=CALL

# 错误（缺少=号）
DSP CDR DATE 2025-10-27

# 错误（VALUE 包含空格需要引号）
DSP CDR DATE="2025-10-27" TYPE="CALL"
```

---

## 📊 性能监控

### 实时查看性能

```bash
# CPU 使用率
DSP PERF CPU

# 内存使用
DSP PERF MEM

# 综合性能
DSP PERF ALL
```

### 查看最近日志

```bash
# 最近 50 条
DSP LOG RECENT LINES=50

# 搜索错误
DSP LOG SEARCH KEYWORD=ERROR
```

---

## 🎯 运维场景

### 场景 1：用户投诉无法注册

```bash
# 1. 查看注册列表
DSP REG ALL

# 2. 查找特定用户
DSP REG URI=sip:1001@ims.com

# 3. 如果存在异常，强制注销
RMV REG URI=sip:1001@ims.com CONFIRM=YES

# 4. 让用户重新注册
# 5. 查看日志确认
DSP LOG RECENT LINES=20
```

### 场景 2：呼叫异常排查

```bash
# 1. 查看活跃呼叫
DSP CALL ACTIVE

# 2. 查看呼叫统计
DSP CALL STAT

# 3. 查看 CDR
DSP CDR DATE=TODAY TYPE=CALL

# 4. 搜索日志
DSP LOG SEARCH KEYWORD=INVITE
```

### 场景 3：性能问题诊断

```bash
# 1. 查看系统状态
DSP SRVSTAT

# 2. 查看性能指标
DSP PERF ALL

# 3. 查看注册数
DSP REG STAT

# 4. 查看呼叫统计
DSP CALL STAT

# 5. 如果性能低，降低日志级别
SET LOG LEVEL=WARNING
```

---

## 🔗 相关资源

- [完整文档](web/README.md)
- [命令参考](docs/MML_COMMAND_REFERENCE.md)（计划中）
- [IMS 路线图](docs/IMS_ROADMAP.md)

---

## ✅ 下一步

1. **熟悉界面**：试用各个功能区
2. **练习命令**：从简单命令开始
3. **查看文档**：深入了解高级功能
4. **定制扩展**：添加自定义命令

---

**开始体验专业的运营商级管理界面！** 🎉

**最后更新**：2025-10-27

