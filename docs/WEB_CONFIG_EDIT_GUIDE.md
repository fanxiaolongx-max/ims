# Web é…ç½®ç¼–è¾‘åŠŸèƒ½ä½¿ç”¨æŒ‡å—

## ğŸ‰ åŠŸèƒ½æ¦‚è¿°

IMS SIP æœåŠ¡å™¨ç°å·²æ”¯æŒ**åŠ¨æ€é…ç½®ä¿®æ”¹**åŠŸèƒ½ï¼Œå¯ä»¥åœ¨ä¸é‡å¯æœåŠ¡å™¨çš„æƒ…å†µä¸‹ä¿®æ”¹é…ç½®å‚æ•°ï¼

### âœ¨ æ ¸å¿ƒç‰¹æ€§

- âœ… **åŠ¨æ€ä¿®æ”¹** - æ— éœ€é‡å¯æœåŠ¡å™¨ï¼Œä¿®æ”¹ç«‹å³ç”Ÿæ•ˆ
- âœ… **æŒä¹…åŒ–å­˜å‚¨** - é…ç½®è‡ªåŠ¨ä¿å­˜åˆ° `config.json` æ–‡ä»¶
- âœ… **å®‰å…¨éªŒè¯** - å†…ç½®å‚æ•°éªŒè¯ï¼Œé˜²æ­¢é”™è¯¯é…ç½®
- âœ… **ä¸å½±å“ä¸šåŠ¡** - ä¿®æ”¹è¿‡ç¨‹ä¸å½±å“æ­£åœ¨è¿›è¡Œçš„å‘¼å«
- âœ… **å‹å¥½ç•Œé¢** - ç®€æ´ç¾è§‚çš„ Web ç¼–è¾‘ç•Œé¢

## ğŸ“‹ å¯ä¿®æ”¹çš„é…ç½®é¡¹

### âœ… æ”¯æŒåŠ¨æ€ä¿®æ”¹ï¼ˆæ— éœ€é‡å¯ï¼‰

| é…ç½®é¡¹ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| **USERS** | dict | ç”¨æˆ·è´¦å·å’Œå¯†ç  | `{"1001": "1234", "1002": "5678"}` |
| **FORCE_LOCAL_ADDR** | bool | å¼ºåˆ¶æœ¬åœ°åœ°å€æ¨¡å¼ | `true` / `false` |
| **LOCAL_NETWORKS** | list | æœ¬åœ°ç½‘ç»œåœ°å€åˆ—è¡¨ | `["127.0.0.1", "192.168.8.0/16"]` |
| **LOG_LEVEL** | str | æ—¥å¿—çº§åˆ« | `DEBUG` / `INFO` / `WARNING` / `ERROR` |
| **CDR_MERGE_MODE** | bool | CDR è®°å½•åˆå¹¶æ¨¡å¼ | `true` / `false` |

### âŒ ä¸æ”¯æŒåŠ¨æ€ä¿®æ”¹ï¼ˆéœ€è¦é‡å¯ï¼‰

| é…ç½®é¡¹ | ç±»å‹ | è¯´æ˜ | åŸå›  |
|--------|------|------|------|
| **SERVER_IP** | str | æœåŠ¡å™¨ IP åœ°å€ | UDP socket å·²ç»‘å®š |
| **SERVER_PORT** | int | æœåŠ¡å™¨ç«¯å£ | UDP socket å·²ç»‘å®š |

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³• 1: Web ç•Œé¢ç¼–è¾‘ï¼ˆæ¨èï¼‰

1. **å¯åŠ¨æœåŠ¡å™¨**
   ```bash
   cd /Volumes/512G/06-å·¥å…·å¼€å‘/ims
   python run.py
   ```

2. **æ‰“å¼€ç¼–è¾‘æµ‹è¯•é¡µé¢**
   ```
   æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼šfile:///Volumes/512G/06-å·¥å…·å¼€å‘/ims/web_config_edit_demo.html
   ```

3. **ç¼–è¾‘é…ç½®**
   - ç‚¹å‡»é…ç½®é¡¹å³ä¾§çš„"âœï¸ ç¼–è¾‘"æŒ‰é’®
   - ä¿®æ”¹å€¼
   - ç‚¹å‡»"ğŸ’¾ ä¿å­˜"
   - æŸ¥çœ‹æˆåŠŸæç¤º

### æ–¹æ³• 2: API ç›´æ¥è°ƒç”¨

#### è·å–å½“å‰é…ç½®

```bash
curl http://127.0.0.1:8080/api/config
```

#### è·å–å¯ç¼–è¾‘é…ç½®é¡¹

```bash
curl http://127.0.0.1:8080/api/config/editable
```

#### ä¿®æ”¹é…ç½®

**ä¿®æ”¹å¸ƒå°”å€¼ï¼š**
```bash
curl -X POST http://127.0.0.1:8080/api/config/update \
  -H "Content-Type: application/json" \
  -d '{"key": "FORCE_LOCAL_ADDR", "value": true}'
```

**ä¿®æ”¹å­—ç¬¦ä¸²ï¼š**
```bash
curl -X POST http://127.0.0.1:8080/api/config/update \
  -H "Content-Type: application/json" \
  -d '{"key": "LOG_LEVEL", "value": "INFO"}'
```

**ä¿®æ”¹ç”¨æˆ·åˆ—è¡¨ï¼š**
```bash
curl -X POST http://127.0.0.1:8080/api/config/update \
  -H "Content-Type: application/json" \
  -d '{"key": "USERS", "value": {"1001": "1234", "1002": "5678", "1004": "9999"}}'
```

**ä¿®æ”¹ç½‘ç»œåˆ—è¡¨ï¼š**
```bash
curl -X POST http://127.0.0.1:8080/api/config/update \
  -H "Content-Type: application/json" \
  -d '{"key": "LOCAL_NETWORKS", "value": ["127.0.0.1", "192.168.8.0/16", "10.0.0.0/8"]}'
```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: åŠ¨æ€æ·»åŠ ç”¨æˆ·

**åœºæ™¯ï¼š** éœ€è¦ä¸ºæ–°ç”¨æˆ· 1004 åˆ›å»ºè´¦å·

```bash
# 1. æŸ¥çœ‹å½“å‰ç”¨æˆ·
curl -s http://127.0.0.1:8080/api/config | python -c "import sys, json; print(json.load(sys.stdin)['USERS'])"

# 2. æ·»åŠ æ–°ç”¨æˆ· 1004
curl -X POST http://127.0.0.1:8080/api/config/update \
  -H "Content-Type: application/json" \
  -d '{"key": "USERS", "value": {"1001": "1234", "1002": "1234", "1003": "1234", "1004": "5678"}}'

# 3. éªŒè¯ä¿®æ”¹
curl -s http://127.0.0.1:8080/api/config | python -c "import sys, json; print(json.load(sys.stdin)['USERS'])"

# 4. æ–°ç”¨æˆ· 1004 å¯ä»¥ç«‹å³æ³¨å†Œå’Œå‘¼å«ï¼Œæ— éœ€é‡å¯æœåŠ¡å™¨ï¼
```

### ç¤ºä¾‹ 2: åˆ‡æ¢ç½‘ç»œæ¨¡å¼

**åœºæ™¯ï¼š** ä»æµ‹è¯•æ¨¡å¼åˆ‡æ¢åˆ°ç”Ÿäº§æ¨¡å¼

```bash
# 1. ç¦ç”¨å¼ºåˆ¶æœ¬åœ°åœ°å€æ¨¡å¼
curl -X POST http://127.0.0.1:8080/api/config/update \
  -H "Content-Type: application/json" \
  -d '{"key": "FORCE_LOCAL_ADDR", "value": false}'

# 2. æ·»åŠ ç”Ÿäº§ç½‘ç»œåœ°å€
curl -X POST http://127.0.0.1:8080/api/config/update \
  -H "Content-Type: application/json" \
  -d '{"key": "LOCAL_NETWORKS", "value": ["127.0.0.1", "192.168.0.0/16", "10.0.0.0/8"]}'

# å®Œæˆï¼é…ç½®ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯
```

### ç¤ºä¾‹ 3: è°ƒæ•´æ—¥å¿—çº§åˆ«

**åœºæ™¯ï¼š** ç”Ÿäº§ç¯å¢ƒå‡å°‘æ—¥å¿—è¾“å‡º

```bash
# ä» DEBUG åˆ‡æ¢åˆ° INFO
curl -X POST http://127.0.0.1:8080/api/config/update \
  -H "Content-Type: application/json" \
  -d '{"key": "LOG_LEVEL", "value": "INFO"}'

# æ—¥å¿—çº§åˆ«ç«‹å³ç”Ÿæ•ˆï¼Œæ–°çš„æ—¥å¿—æ¶ˆæ¯å°†ä½¿ç”¨ INFO çº§åˆ«
```

## ğŸ”’ å®‰å…¨æ€§

### é…ç½®éªŒè¯

æ‰€æœ‰é…ç½®ä¿®æ”¹éƒ½ä¼šç»è¿‡ä¸¥æ ¼éªŒè¯ï¼š

1. **ç±»å‹æ£€æŸ¥**
   ```python
   # USERS å¿…é¡»æ˜¯ dict ç±»å‹
   # FORCE_LOCAL_ADDR å¿…é¡»æ˜¯ bool ç±»å‹
   # LOCAL_NETWORKS å¿…é¡»æ˜¯ list ç±»å‹
   ```

2. **å€¼åŸŸæ£€æŸ¥**
   ```python
   # LOG_LEVEL åªèƒ½æ˜¯ DEBUG/INFO/WARNING/ERROR
   # SERVER_PORT å¿…é¡»åœ¨ 1024-65535 èŒƒå›´å†…
   ```

3. **åªè¯»ä¿æŠ¤**
   ```python
   # SERVER_IP å’Œ SERVER_PORT ä¸å¯é€šè¿‡ API ä¿®æ”¹
   # è¿”å›é”™è¯¯ï¼šé…ç½®é¡¹ä¸å¯ä¿®æ”¹ï¼ˆéœ€è¦é‡å¯æœåŠ¡å™¨ï¼‰
   ```

### é”™è¯¯å¤„ç†

é…ç½®ä¿®æ”¹å¤±è´¥æ—¶ä¼šè¿”å›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼š

```json
{
    "success": false,
    "message": "é…ç½®é¡¹ LOG_LEVEL çš„å€¼æ— æ•ˆ",
    "key": "LOG_LEVEL",
    "value": "INVALID"
}
```

## ğŸ“‚ é…ç½®æ–‡ä»¶

### config.json

æ‰€æœ‰åŠ¨æ€é…ç½®éƒ½ä¿å­˜åœ¨ `config.json` æ–‡ä»¶ä¸­ï¼š

```json
{
    "USERS": {
        "1001": "1234",
        "1002": "1234",
        "1003": "1234",
        "1004": "5678"
    },
    "FORCE_LOCAL_ADDR": false,
    "LOCAL_NETWORKS": [
        "127.0.0.1",
        "localhost",
        "192.168.8.0/16"
    ],
    "LOG_LEVEL": "INFO",
    "CDR_MERGE_MODE": true
}
```

**ç‰¹ç‚¹ï¼š**
- âœ… è‡ªåŠ¨ä¿å­˜ - æ¯æ¬¡ä¿®æ”¹è‡ªåŠ¨å†™å…¥
- âœ… è‡ªåŠ¨åŠ è½½ - æœåŠ¡å™¨å¯åŠ¨æ—¶è‡ªåŠ¨è¯»å–
- âœ… ç‰ˆæœ¬æ§åˆ¶ - å¯çº³å…¥ Git ç®¡ç†
- âœ… å¤‡ä»½æ¢å¤ - å¯æ‰‹åŠ¨ç¼–è¾‘å’Œæ¢å¤

## ğŸ¯ æœ€ä½³å®è·µ

### 1. ä¿®æ”¹å‰å¤‡ä»½

```bash
# å¤‡ä»½å½“å‰é…ç½®
cp config.json config.json.backup.$(date +%Y%m%d)
```

### 2. æ‰¹é‡ä¿®æ”¹ç­–ç•¥

å¯¹äºå¤šä¸ªé…ç½®é¡¹çš„ä¿®æ”¹ï¼Œå»ºè®®é€ä¸ªä¿®æ”¹å¹¶éªŒè¯ï¼š

```bash
# âœ… æ¨èï¼šé€ä¸ªä¿®æ”¹
curl -X POST ... -d '{"key": "USERS", "value": {...}}'
# éªŒè¯æˆåŠŸåå†ä¿®æ”¹ä¸‹ä¸€ä¸ª
curl -X POST ... -d '{"key": "LOCAL_NETWORKS", "value": [...]}'

# âŒ ä¸æ¨èï¼šåŒæ—¶ä¿®æ”¹å¤šä¸ªï¼ˆå‡ºé”™éš¾ä»¥å®šä½ï¼‰
```

### 3. ç”Ÿäº§ç¯å¢ƒä¿®æ”¹

ç”Ÿäº§ç¯å¢ƒä¿®æ”¹é…ç½®æ—¶çš„å»ºè®®æµç¨‹ï¼š

1. **æµ‹è¯•ç¯å¢ƒéªŒè¯** - å…ˆåœ¨æµ‹è¯•ç¯å¢ƒæµ‹è¯•ä¿®æ”¹
2. **å°èŒƒå›´è¯•ç‚¹** - åœ¨ç”Ÿäº§ç¯å¢ƒå°èŒƒå›´è¯•ç‚¹
3. **ç›‘æ§è§‚å¯Ÿ** - è§‚å¯Ÿæ—¥å¿—å’Œ CDRï¼Œç¡®è®¤æ— å¼‚å¸¸
4. **å…¨é‡åº”ç”¨** - ç¡®è®¤æ— é—®é¢˜åå…¨é‡åº”ç”¨

### 4. é…ç½®å›æ»š

å¦‚æœä¿®æ”¹åå‡ºç°é—®é¢˜ï¼Œå¿«é€Ÿå›æ»šï¼š

```bash
# æ–¹æ³• 1: æ¢å¤å¤‡ä»½æ–‡ä»¶
cp config.json.backup.20251027 config.json

# æ–¹æ³• 2: é€šè¿‡ API å›æ»šå•ä¸ªé…ç½®
curl -X POST http://127.0.0.1:8080/api/config/update \
  -H "Content-Type: application/json" \
  -d '{"key": "USERS", "value": {"1001": "1234", "1002": "1234", "1003": "1234"}}'
```

## â“ å¸¸è§é—®é¢˜

### Q1: ä¿®æ”¹åæ˜¯å¦éœ€è¦é‡å¯æœåŠ¡å™¨ï¼Ÿ

**A**: ä¸éœ€è¦ï¼æ‰€æœ‰å¯åŠ¨æ€ä¿®æ”¹çš„é…ç½®éƒ½ä¼šç«‹å³ç”Ÿæ•ˆã€‚åªæœ‰ `SERVER_IP` å’Œ `SERVER_PORT` éœ€è¦é‡å¯ã€‚

### Q2: ä¿®æ”¹ç”¨æˆ·åˆ—è¡¨åï¼Œæ—§ç”¨æˆ·ä¼šè¢«è¸¢å‡ºå—ï¼Ÿ

**A**: ä¸ä¼šã€‚å·²æ³¨å†Œçš„ç”¨æˆ·ä¼šä¿æŒè¿æ¥ï¼Œåªæ˜¯æ–°çš„è®¤è¯ä¼šä½¿ç”¨æ–°çš„ç”¨æˆ·åˆ—è¡¨ã€‚

### Q3: é…ç½®æ–‡ä»¶è¢«è¯¯åˆ é™¤æ€ä¹ˆåŠï¼Ÿ

**A**: æœåŠ¡å™¨ä¼šç»§ç»­ä½¿ç”¨å†…å­˜ä¸­çš„é…ç½®è¿è¡Œã€‚å¯ä»¥é€šè¿‡ API é‡æ–°è®¾ç½®é…ç½®ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„ `config.json` æ–‡ä»¶ã€‚

### Q4: å¯ä»¥æ·»åŠ æ–°çš„é…ç½®é¡¹å—ï¼Ÿ

**A**: å¯ä»¥ã€‚åœ¨ `config_manager.py` çš„ `DYNAMIC_CONFIG` ä¸­æ·»åŠ æ–°çš„é…ç½®é¡¹å®šä¹‰ï¼Œå¹¶åœ¨ `apply_config_change()` ä¸­å®ç°åº”ç”¨é€»è¾‘ã€‚

### Q5: å¤šä¸ªç®¡ç†å‘˜åŒæ—¶ä¿®æ”¹é…ç½®ä¼šå†²çªå—ï¼Ÿ

**A**: ä½¿ç”¨äº†çº¿ç¨‹é”ä¿æŠ¤ï¼Œä¸ä¼šå‡ºç°æ•°æ®ç«äº‰ã€‚ä½†æœ€åçš„ä¿®æ”¹ä¼šè¦†ç›–ä¹‹å‰çš„ä¿®æ”¹ã€‚

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: API è¿”å› 404

**å¯èƒ½åŸå› ï¼š**
- Web æœåŠ¡å™¨æœªå¯åŠ¨
- ç«¯å£ 8080 è¢«å ç”¨

**è§£å†³æ–¹æ³•ï¼š**
```bash
# æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ
ps aux | grep "python.*run.py"

# æ£€æŸ¥ç«¯å£æ˜¯å¦ç›‘å¬
lsof -i :8080
```

### é—®é¢˜ 2: é…ç½®ä¿®æ”¹å¤±è´¥

**å¯èƒ½åŸå› ï¼š**
- å‚æ•°ç±»å‹é”™è¯¯
- å‚æ•°å€¼æ— æ•ˆ

**è§£å†³æ–¹æ³•ï¼š**
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
curl -X POST http://127.0.0.1:8080/api/config/update \
  -H "Content-Type: application/json" \
  -d '{"key": "LOG_LEVEL", "value": "INVALID"}' 2>&1 | jq .message
```

### é—®é¢˜ 3: é…ç½®æ²¡æœ‰ç”Ÿæ•ˆ

**å¯èƒ½åŸå› ï¼š**
- é…ç½®ä¿å­˜æˆåŠŸä½†åº”ç”¨å¤±è´¥
- ç¼“å­˜æœªåˆ·æ–°

**è§£å†³æ–¹æ³•ï¼š**
```bash
# æ£€æŸ¥ config.json æ–‡ä»¶å†…å®¹
cat config.json

# æ£€æŸ¥è¿è¡Œæ—¶é…ç½®
curl -s http://127.0.0.1:8080/api/config | jq .USERS

# æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
tail -f ims-sip-server.log | grep CONFIG
```

## ğŸ“š å‚è€ƒèµ„æ–™

- [config_manager.py](config_manager.py) - é…ç½®ç®¡ç†æ¨¡å—æºç 
- [web_config.py](web_config.py) - Web æ¥å£å®ç°
- [web_config_edit_demo.html](web_config_edit_demo.html) - ç¼–è¾‘ç•Œé¢ç¤ºä¾‹

---

**ç‰ˆæœ¬**: v2.5  
**æœ€åæ›´æ–°**: 2025-10-27  
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª

